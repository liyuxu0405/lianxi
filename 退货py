import streamlit as st
import pandas as pd
import io
import os
import glob
import zipfile
import time
import csv
from datetime import datetime, timedelta, date

# ================= é…ç½®åŒºåŸŸ =================
DATA_DIR = "uploaded_data"
LOG_FILE = "operation_logs.csv"

if not os.path.exists(DATA_DIR):
    os.makedirs(DATA_DIR)

USERS = st.secrets["passwords"]
RETENTION_DAYS = 7  # æ–‡ä»¶ä¿ç•™7å¤©

# ================= é¡µé¢é…ç½® =================
st.set_page_config(
    page_title="ç”µå•†åä½œç³»ç»ŸÂ·ä¼ä¸šç‰ˆ",
    page_icon="ğŸš€",
    layout="wide"
)


# ================= æ—¥å¿—ä¸æ¸…ç† =================
def log_action(user, action, detail=""):
    try:
        file_exists = os.path.isfile(LOG_FILE)
        now_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        with open(LOG_FILE, mode='a', newline='', encoding='utf-8-sig') as f:
            writer = csv.writer(f)
            if not file_exists:
                writer.writerow(["æ—¶é—´", "ç”¨æˆ·", "æ“ä½œç±»å‹", "è¯¦ç»†ä¿¡æ¯"])
            writer.writerow([now_time, user, action, detail])
    except:
        pass


def auto_cleanup_old_files():
    try:
        now = time.time()
        retention_seconds = RETENTION_DAYS * 24 * 3600
        files = glob.glob(os.path.join(DATA_DIR, "*.xlsx"))
        for f in files:
            try:
                # æ£€æŸ¥æ–‡ä»¶ä¿®æ”¹æ—¶é—´
                if now - os.path.getmtime(f) > retention_seconds:
                    os.remove(f)
            except:
                pass
    except:
        pass


# ================= å·¥å…·å‡½æ•° =================
def smart_read(uploaded_file, dtype_str=False):
    try:
        file_ext = uploaded_file.name.split('.')[-1].lower()
        if file_ext in ['xls', 'xlsx']:
            return pd.read_excel(uploaded_file, dtype=str if dtype_str else None)
        else:
            bytes_data = uploaded_file.getvalue()
            for enc in ['utf-8', 'gbk', 'gb18030']:
                try:
                    return pd.read_csv(io.BytesIO(bytes_data), encoding=enc, dtype=str)
                except:
                    continue
            return None
    except Exception as e:
        st.error(f"âŒ è¯»å–å¤±è´¥: {e}")
        return None


def to_excel_bytes(df):
    output = io.BytesIO()
    with pd.ExcelWriter(output, engine='xlsxwriter') as writer:
        df.to_excel(writer, index=False, sheet_name='Sheet1')
        workbook = writer.book
        worksheet = writer.sheets['Sheet1']
        format1 = workbook.add_format({'num_format': '@'})
        for i, col in enumerate(df.columns):
            worksheet.set_column(i, i, 20, format1)
    return output.getvalue()


def distribute_codes(group):
    if 'å•†å®¶å¤‡æ³¨' not in group.columns:
        return group
    rows_count = len(group)
    first_remark = str(group.iloc[0]['å•†å®¶å¤‡æ³¨'])
    temp_str = first_remark.replace('\n', '|')
    codes_list = [c.strip() for c in temp_str.split('|') if c.strip()]
    if rows_count > 1 and len(codes_list) == rows_count:
        group['å•†å®¶å¤‡æ³¨'] = codes_list
        return group
    if rows_count == 1 and len(codes_list) > 1:
        if len(set(codes_list)) == 1:
            group['å•†å®¶å¤‡æ³¨'] = codes_list[0]
            return group
    unique_codes = sorted(list(set(codes_list)), key=codes_list.index)
    if rows_count > 1 and len(unique_codes) == rows_count:
        group['å•†å®¶å¤‡æ³¨'] = unique_codes
        return group
    group['å•†å®¶å¤‡æ³¨'] = group['å•†å®¶å¤‡æ³¨'].astype(str).str.replace('|', '', regex=False).str.strip()
    return group


# ================= ç™»å½•é€»è¾‘ =================
def check_password():
    def password_entered():
        if st.session_state["username"] in USERS and st.session_state["password"] == USERS[
            st.session_state["username"]]:
            st.session_state["password_correct"] = True
            st.session_state["current_user"] = st.session_state["username"]
            log_action(st.session_state["username"], "ç™»å½•ç³»ç»Ÿ", "ç™»å½•æˆåŠŸ")
            del st.session_state["password"]
        else:
            st.session_state["password_correct"] = False

    if "password_correct" not in st.session_state:
        st.markdown("## ğŸ”’ ä¼ä¸šåä½œç³»ç»Ÿç™»å½•")
        st.text_input("è´¦å·", key="username")
        st.text_input("å¯†ç ", type="password", key="password")
        st.button("ç™»å½•", on_click=password_entered)
        return False
    elif not st.session_state["password_correct"]:
        st.markdown("## ğŸ”’ ä¼ä¸šåä½œç³»ç»Ÿç™»å½•")
        st.text_input("è´¦å·", key="username")
        st.text_input("å¯†ç ", type="password", key="password")
        st.button("ç™»å½•", on_click=password_entered)
        st.error("âŒ è´¦å·æˆ–å¯†ç é”™è¯¯")
        return False
    else:
        return True


# ================= ä¸»ç¨‹åº =================
if check_password():
    auto_cleanup_old_files()
    current_user = st.session_state["current_user"]

    with st.sidebar:
        st.write(f"ğŸ‘¤ ç”¨æˆ·: **{current_user}**")
        is_warehouse = current_user in ["cangku", "admin"]
        is_developer = current_user in ["kaifa", "admin"]

        menu_options = ["ä»»åŠ¡ä¸€ï¼š24å°æ—¶è¶…æ—¶ç­›é€‰", "ä»»åŠ¡äºŒï¼šä»“åº“è¡¨æ ¼æ¸…æ´— (è‡ªåŠ¨æäº¤)"]
        if is_warehouse:
            menu_options.insert(0, "ğŸ­ ä»“åº“æ€»æ§å° (ä¸‹è½½æ±‡æ€»)")
        if is_developer:
            menu_options.append("ğŸ‘¨â€ğŸ’» å¼€å‘è€…åå° (æ“ä½œæ—¥å¿—)")

        task = st.radio("ğŸ‘‰ èœå•å¯¼èˆª", menu_options)

        st.markdown("---")
        if is_warehouse and task == "ğŸ­ ä»“åº“æ€»æ§å° (ä¸‹è½½æ±‡æ€»)":
            if st.button("ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ•°æ®", type="primary"):
                files = glob.glob(os.path.join(DATA_DIR, "*.xlsx"))
                for f in files:
                    os.remove(f)
                log_action(current_user, "æ¸…ç©ºæ•°æ®")
                st.success("å·²æ¸…ç©ºï¼")
                time.sleep(1)
                st.rerun()

        if st.button("é€€å‡ºç™»å½•"):
            log_action(current_user, "é€€å‡ºç³»ç»Ÿ")
            del st.session_state["password_correct"]
            del st.session_state["current_user"]
            st.rerun()

    # --- å¼€å‘è€…åå° ---
    if task == "ğŸ‘¨â€ğŸ’» å¼€å‘è€…åå° (æ“ä½œæ—¥å¿—)":
        st.title("ğŸ‘¨â€ğŸ’» ç³»ç»Ÿæ“ä½œæ—¥å¿—")
        if os.path.exists(LOG_FILE):
            log_df = pd.read_csv(LOG_FILE)
            st.dataframe(log_df.iloc[::-1], use_container_width=True)
            st.download_button("ğŸ“¥ ä¸‹è½½æ—¥å¿—", open(LOG_FILE, "rb").read(), "logs.csv", "text/csv")
        else:
            st.info("æš‚æ— æ—¥å¿—ã€‚")

    # --- ä»“åº“æ€»æ§å° (å·²å‡çº§æ—¥æœŸç­›é€‰) ---
    elif task == "ğŸ­ ä»“åº“æ€»æ§å° (ä¸‹è½½æ±‡æ€»)":
        st.title("ğŸ­ ä»“åº“æ€»æ•°æ®æ±‡æ€»")

        # === ğŸ”¥ 1. å¢åŠ æ—¥æœŸç­›é€‰ç»„ä»¶ ===
        st.markdown("### ğŸ“… æ•°æ®ç­›é€‰")
        col_date, col_info = st.columns([1, 2])
        with col_date:
            # é»˜è®¤é€‰ä»Šå¤©
            today = datetime.now().date()
            # å…è®¸é€‰æ‹©æ—¶é—´æ®µ
            selected_date = st.date_input(
                "è¯·é€‰æ‹©è¦æ±‡æ€»çš„æ—¥æœŸ (æ”¯æŒè·¨å¤©)",
                value=(today, today),  # é»˜è®¤ä»Šå¤©åˆ°ä»Šå¤©
                help="å¦‚æœæ˜¯è¡¥å‘¨å…­å‘¨æ—¥çš„æ•°æ®ï¼Œè¯·æŠŠèŒƒå›´é€‰å®½ä¸€ç‚¹"
            )

        # å¤„ç†æ—¥æœŸèŒƒå›´é€»è¾‘
        if isinstance(selected_date, tuple):
            if len(selected_date) == 2:
                start_date, end_date = selected_date
            elif len(selected_date) == 1:
                start_date = end_date = selected_date[0]
            else:
                start_date = end_date = today
        else:
            start_date = end_date = selected_date

        # === 2. ç­›é€‰ç¬¦åˆæ—¥æœŸçš„æ–‡ä»¶ ===
        all_files = glob.glob(os.path.join(DATA_DIR, "*.xlsx"))
        target_files = []

        for f in all_files:
            try:
                # è·å–æ–‡ä»¶ä¿®æ”¹æ—¶é—´æˆ³
                mtime = os.path.getmtime(f)
                file_date = datetime.fromtimestamp(mtime).date()
                # åˆ¤æ–­æ˜¯å¦åœ¨é€‰ä¸­èŒƒå›´å†…
                if start_date <= file_date <= end_date:
                    target_files.append(f)
            except:
                pass

        # === 3. æ˜¾ç¤ºç»“æœ ===
        if not target_files:
            if not all_files:
                st.warning("ğŸ“­ ç³»ç»Ÿé‡Œæ²¡æœ‰ä»»ä½•æ•°æ®ã€‚")
            else:
                st.warning(f"ğŸ” åœ¨ {start_date} åˆ° {end_date} æœŸé—´ï¼Œæ²¡æœ‰æ‰¾åˆ°æäº¤è®°å½•ã€‚")
                st.info("æç¤ºï¼šè¯·æ£€æŸ¥æ—¥æœŸæ˜¯å¦é€‰å¯¹ï¼Œæˆ–è€…å‘˜å·¥æ˜¯å¦æ˜¯åœ¨è¿™å‡ å¤©æäº¤çš„ã€‚")
        else:
            with col_info:
                st.success(f"âœ… åœ¨æ‰€é€‰æ—¥æœŸèŒƒå›´å†…ï¼Œæ‰¾åˆ° **{len(target_files)}** ä»½è¡¨æ ¼ã€‚")

            df_list = []
            for f in target_files:
                try:
                    temp_df = pd.read_excel(f, dtype=str)

                    filename = os.path.basename(f)
                    if "[" in filename and "]" in filename:
                        submitter = filename.split("]")[0].replace("[", "")
                    else:
                        submitter = "æœªçŸ¥"

                    temp_df.insert(0, "_sys_æäº¤äºº", submitter)
                    temp_df.insert(1, "_sys_æ¥æºæ–‡ä»¶", filename)
                    df_list.append(temp_df)
                except:
                    pass

            if df_list:
                total_df = pd.concat(df_list, ignore_index=True)
                raw_count = len(total_df)

                # å»é‡é€»è¾‘
                business_cols = [c for c in total_df.columns if not c.startswith("_sys_")]
                total_df = total_df.drop_duplicates(subset=business_cols, keep='first')
                final_count = len(total_df)

                # é¢„è§ˆ
                display_df = total_df.rename(columns={"_sys_æäº¤äºº": "æäº¤äºº", "_sys_æ¥æºæ–‡ä»¶": "æ¥æºæ–‡ä»¶"})
                st.dataframe(display_df)

                st.markdown("### ğŸ“¥ ä¸‹è½½åŒºåŸŸï¼š")
                col1, col2 = st.columns(2)

                # æ–‡ä»¶åå¸¦ä¸Šæ—¥æœŸèŒƒå›´ï¼Œæ–¹ä¾¿å½’æ¡£
                date_range_str = f"{start_date.strftime('%Y%m%d')}"
                if start_date != end_date:
                    date_range_str += f"-{end_date.strftime('%Y%m%d')}"

                with col1:
                    clean_cols = [c for c in total_df.columns if not c.startswith("_sys_")]
                    clean_df = total_df[clean_cols]
                    st.download_button(
                        label="ğŸš€ ä¸‹è½½çº¯å‡€ç‰ˆ (å¯¼å…¥ç³»ç»Ÿä¸“ç”¨)",
                        data=to_excel_bytes(clean_df),
                        file_name=f"ç³»ç»Ÿå¯¼å…¥_{date_range_str}.xlsx",
                        mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                        type="primary",
                        help="ä¸å«æäº¤äººï¼Œå·²å»é‡"
                    )

                with col2:
                    st.download_button(
                        label="ğŸ“„ ä¸‹è½½æ ¸å¯¹ç‰ˆ (å«æäº¤äºº)",
                        data=to_excel_bytes(display_df),
                        file_name=f"ç®¡ç†å‘˜æ ¸å¯¹_{date_range_str}.xlsx",
                        mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                        help="å«æäº¤äººä¿¡æ¯"
                    )

    # --- ä»»åŠ¡ä¸€ ---
    elif task == "ä»»åŠ¡ä¸€ï¼š24å°æ—¶è¶…æ—¶ç­›é€‰":
        st.header("â³ ä»»åŠ¡ä¸€ï¼šè¶…æ—¶è®¢å•ç­›é€‰")
        uploaded_files = st.file_uploader("ä¸Šä¼ æ–‡ä»¶", type=['xls', 'xlsx', 'csv'], accept_multiple_files=True, key="t1")
        if uploaded_files and st.button("å¼€å§‹ç­›é€‰", key="btn1"):
            log_action(current_user, "ä»»åŠ¡ä¸€", str(len(uploaded_files)) + "ä¸ªæ–‡ä»¶")
            today = datetime.now().date()
            target_dates = [today, today + timedelta(days=1), today + timedelta(days=2)]
            all_dfs = []
            for file in uploaded_files:
                df = smart_read(file)
                if df is not None:
                    df.columns = df.columns.str.strip()
                    if 'è¶…æ—¶æ—¶é—´' in df.columns:
                        df['è¶…æ—¶æ—¶é—´_æ—¥æœŸ'] = pd.to_datetime(df['è¶…æ—¶æ—¶é—´'], errors='coerce').dt.date
                        filtered = df[df['è¶…æ—¶æ—¶é—´_æ—¥æœŸ'].isin(target_dates)].copy()
                        if not filtered.empty:
                            needed = ['è®¢å•ç¼–å·', 'é€€è´§ç‰©æµå…¬å¸', 'é€€è´§ç‰©æµå•å·', 'è¶…æ—¶æ—¶é—´']
                            actual = [c for c in needed if c in filtered.columns]
                            for col in ['è®¢å•ç¼–å·', 'é€€è´§ç‰©æµå•å·']:
                                if col in filtered.columns:
                                    filtered[col] = filtered[col].astype(str).str.replace(r'\.0$', '', regex=True)
                            all_dfs.append(filtered[actual])
            if all_dfs:
                final_df = pd.concat(all_dfs, ignore_index=True)
                st.success(f"ç­›é€‰å®Œæˆ {len(final_df)} æ¡")
                st.dataframe(final_df)
                st.download_button("ğŸ“¥ ä¸‹è½½ç»“æœ", to_excel_bytes(final_df), "å³å°†è¶…æ—¶.xlsx")
            else:
                st.warning("æ— åŒ¹é…æ•°æ®")

    # --- ä»»åŠ¡äºŒ ---
    elif task == "ä»»åŠ¡äºŒï¼šä»“åº“è¡¨æ ¼æ¸…æ´— (è‡ªåŠ¨æäº¤)":
        st.header("ğŸ­ ä»»åŠ¡äºŒï¼šä»“åº“è¡¨æ ¼æ¸…æ´—")
        uploaded_files = st.file_uploader("ä¸Šä¼ æ–‡ä»¶", type=['xls', 'xlsx', 'csv'], accept_multiple_files=True, key="t2")
        if uploaded_files and st.button("å¼€å§‹æ¸…æ´—", type="primary", key="btn2"):
            log_action(current_user, "ä»»åŠ¡äºŒ", str(len(uploaded_files)) + "ä¸ªæ–‡ä»¶")
            zip_buffer = io.BytesIO()
            processed = 0
            preview_list = []
            with zipfile.ZipFile(zip_buffer, "w") as zf:
                bar = st.progress(0)
                for i, file in enumerate(uploaded_files):
                    try:
                        df = smart_read(file, dtype_str=True)
                        if df is not None:
                            if 'é€€è´§ç‰©æµå•å·' in df.columns: df = df.dropna(subset=['é€€è´§ç‰©æµå•å·'])
                            if 'è®¢å•ç¼–å·' in df.columns and 'å•†å®¶å¤‡æ³¨' in df.columns:
                                df = df.groupby('è®¢å•ç¼–å·', group_keys=False).apply(distribute_codes)

                            target = pd.DataFrame()
                            target['è®¢å•å·'] = df.get('è®¢å•ç¼–å·', '')
                            target['å¿«é€’'] = df.get('é€€è´§ç‰©æµå…¬å¸', '')
                            target['è¿å•å·'] = df.get('é€€è´§ç‰©æµå•å·', '')
                            if 'å•†å®¶å¤‡æ³¨' in df.columns:
                                target['å•†å“'] = df['å•†å®¶å¤‡æ³¨'].astype(str).str.replace('|', '',
                                                                                        regex=False).str.strip()
                            else:
                                target['å•†å“'] = ""
                            target['é€€æ¬¾æ•°é‡'] = 1
                            target['é€€è´§ç±»å‹'] = 'ä¸ƒå¤©æ— ç†ç”±é€€è´§'

                            # ğŸ”¥ å‡çº§æ–‡ä»¶åï¼šåŠ å…¥æ—¥æœŸ 20231225
                            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
                            server_filename = f"[{current_user}]_{file.name.split('.')[0]}_{timestamp}.xlsx"
                            target.to_excel(os.path.join(DATA_DIR, server_filename), index=False)

                            zf.writestr(f"æ¸…æ´—å®Œ_{file.name.rsplit('.', 1)[0]}.xlsx", to_excel_bytes(target))
                            preview_list.append((file.name, target))
                            processed += 1
                    except:
                        pass
                    bar.progress((i + 1) / len(uploaded_files))

            if processed > 0:
                st.success("å¤„ç†æˆåŠŸï¼å·²è‡ªåŠ¨æäº¤åˆ°ä»“åº“ã€‚")
                for n, d in preview_list:
                    with st.expander(f"ğŸ“„ {n}", expanded=False): st.dataframe(d)
                st.download_button("ğŸ“¦ ä¸‹è½½æ¸…æ´—åŒ…", zip_buffer.getvalue(), "æ¸…æ´—ç»“æœ.zip", "application/zip")
